<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CISCO PKT</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üåê</text></svg>">
    
    <!-- Vis Network Library (Local) -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/vis-network.min.js') }}"></script>
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" type="text/css" />
    <style>

    </style>
</head>
<body>
    <div class="container">
        <!-- Panel Izquierdo -->
        <div class="left-panel">
            <div class="panel-header">
                <h2> Dise√±ador de Topolog√≠a</h2>
                
            </div>
            
            <div class="tool-section">
                <h3>Dispositivos</h3>
                <button class="btn" onclick="addDevice('router')" style="margin-bottom: 10px;">
                    <img src="{{ url_for('static', filename='assets/mas.png') }}"  style="width:16px; height:16px; vertical-align:middle; margin-right:6px;">
                    Router
                </button>
                <button class="btn" onclick="addDevice('switch')" style="margin-bottom: 10px;">
                    <img src="{{ url_for('static', filename='assets/mas.png') }}"  style="width:16px; height:16px; vertical-align:middle; margin-right:6px;">
                    Switch
                </button>
                <button class="btn" onclick="addDevice('switch_core')" style="margin-bottom: 10px;">
                    <img src="{{ url_for('static', filename='assets/mas.png') }}"  style="width:16px; height:16px; vertical-align:middle; margin-right:6px;">
                    Switch Core
                </button>
            </div>

            <div class="tool-section">
                <h3>VLANs</h3>
                <div class="input-group">
                    <label>Nombre (ej: V2, V10)</label>
                    <input type="text" id="vlan-name" placeholder="V2">
                </div>
                <div class="input-group">
                    <label>Prefijo de Red (8-30)</label>
                    <input type="number" id="vlan-prefix" placeholder="24" min="8" max="30">
                </div>
                <button class="btn" onclick="addVLAN()">
                    <img src="{{ url_for('static', filename='assets/mas.png') }}"  style="width:16px; height:16px; vertical-align:middle; margin-right:6px;">
                    Agregar VLAN
                </button>
                
                <div id="vlan-list" style="margin-top: 15px;">
                    <!-- VLANs agregadas -->
                </div>
            </div>
            

            
            <div class="tool-section">
                <button class="btn" onclick="generateConfigurations()" style="background: #238636;">
                    Generar Configuraci√≥n
                </button>
            </div>
        </div>

        <!-- Canvas Central -->
        <div class="center-panel">
            <div id="network-canvas"></div>
            
            <!-- Botones de Zoom -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="Acercar">
                    <img src="{{ url_for('static', filename='assets/mas.png') }}"  style="width:16px; height:16px; vertical-align:middle;">
                </button>
                </button>
                <button class="zoom-btn" onclick="zoomOut()" title="Alejar">
                    <img src="{{ url_for('static', filename='assets/menos.png') }}"  style="width:16px; height:16px; vertical-align:middle; ">
                </button>
                </button>
            </div>
            
            <!-- Botones Flotantes -->
            <div class="floating-buttons">
                <button class="floating-btn connect" onclick="toggleConnectionMode()" id="connect-btn" title="Conectar Dispositivos">
                    <img src="{{ url_for('static', filename='assets/conexion.png') }}"  style="width:24px; height:24px; vertical-align:middle; ">
                    
                </button>
                <button class="floating-btn delete" onclick="deleteSelected()" title="Eliminar Selecci√≥n">
                    <img src="{{ url_for('static', filename='assets/eliminar.png') }}"  style="width:24px; height:24px; vertical-align:middle; ">
                    
                </button>
            </div>
        </div>

        <!-- Panel Derecho -->
        <div class="right-panel">
            <div class="properties-header">
                <h3>Propiedades</h3>
            </div>
            <div class="properties-content" id="properties-content">
                <p style="color: #8b949e; text-align: center; padding: 40px 20px;">
                    Selecciona un elemento para ver sus propiedades
                </p>
            </div>
        </div>
    </div>
    <!-- MODALES  -->
    
    <!-- Modal para nueva conexi√≥n -->
    {% include 'modals/connection_modal.html' %}
    
    <!-- Modal para editar conexi√≥n -->
    {% include 'modals/edit_connection_modal.html' %}
    
    <!-- Modal para asignar VLAN a computadora -->
    {% include 'modals/computer_vlan_modal.html' %}
    
    <!-- Modal para administrar computadoras de un switch -->
    {% include 'modals/manage_computers_modal.html' %}
    {% include 'modals/add_computer_modal.html' %}

    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        let network = null;
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);
        let vlans = [];
        let routerCounter = 1;
        let switchCounter = 1;
        let switchCoreCounter = 1;
        let computerCounter = 1;
        let connectionMode = false;
        let firstNodeConnection = null;
        let selectedNode = null;
        let selectedEdge = null;
        let editingEdge = null;
        const MIN_ZOOM = 0.3;
        const MAX_ZOOM = 3.0;

        // Inicializar red
        function initNetwork() {
            const container = document.getElementById('network-canvas');
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: {
                    shape: 'circle',
                    size: 30,
                    borderWidth: 2,
                    font: { 
                        color: '#ffffff', 
                        size: 11
                    }
                },
                edges: {
                    color: { color: '#8b949e', highlight: '#58a6ff' },
                    width: 3,
                    smooth: { type: 'continuous' },
                    arrows: {
                        to: {
                            scaleFactor: 1.2
                        },
                        from: {
                            scaleFactor: 1.2
                        }
                    }
                },
                physics: {
                    enabled: false
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true,
                    zoomSpeed: 0.5,
                    hover: true
                }
            };
            
            network = new vis.Network(container, data, options);
            
            // Eventos
            network.on('click', function(params) {
                if (connectionMode && params.nodes.length > 0) {
                    handleConnectionClick(params.nodes[0]);
                } else if (params.nodes.length > 0) {
                    selectNode(params.nodes[0]);
                } else if (params.edges.length > 0) {
                    selectEdge(params.edges[0]);
                } else {
                    clearSelection();
                }
            });
            
            // Doble clic en edge para cambiar direcci√≥n
            network.on('doubleClick', function(params) {
                if (params.edges.length > 0) {
                    const edgeId = params.edges[0];
                    const edge = edges.get(edgeId);
                    
                    // Solo permitir cambio en conexiones entre routers/switch cores
                    const fromNode = nodes.get(edge.from);
                    const toNode = nodes.get(edge.to);
                    const isRoutingEdge = (fromNode.data.type === 'router' || fromNode.data.type === 'switch_core') &&
                                            (toNode.data.type === 'router' || toNode.data.type === 'switch_core');
                    
                    if (isRoutingEdge) {
                        cycleRoutingDirection(edgeId);
                    }
                }
            });
        }
        
        // Convertir direcci√≥n de ruteo a configuraci√≥n de flechas
        function getArrowsForDirection(direction) {
            switch(direction) {
                case 'from-to':
                    return { 
                        to: { 
                            enabled: true, 
                            scaleFactor: 1.2,
                            type: 'arrow'
                        },
                        from: {
                            enabled: false
                        }
                    };
                case 'to-from':
                    return { 
                        to: {
                            enabled: false
                        },
                        from: { 
                            enabled: true, 
                            scaleFactor: 1.2,
                            type: 'arrow'
                        } 
                    };
                case 'bidirectional':
                    return { 
                        to: { 
                            enabled: true, 
                            scaleFactor: 1.2,
                            type: 'arrow'
                        },
                        from: { 
                            enabled: true, 
                            scaleFactor: 1.2,
                            type: 'arrow'
                        }
                    };
                case 'none':
                default:
                    return {
                        to: { enabled: false },
                        from: { enabled: false }
                    };
            }
        }

        // Agregar dispositivo
        function addDevice(type) {
            let name, color, shape, deviceType;
            const x = (Math.random() - 0.5) * 300;
            const y = (Math.random() - 0.5) * 300;
            
            switch(type) {
                case 'router':
                    name = 'R' + routerCounter++;
                    color = { background: '#6e7681', border: '#8b949e' };
                    shape = 'circle';
                    deviceType = 'router';
                    break;
                case 'switch':
                    name = 'SW' + switchCounter++;
                    color = { background: '#6e7681', border: '#8b949e' };
                    shape = 'box';
                    deviceType = 'switch';
                    break;
                case 'switch_core':
                    name = 'SWC' + switchCoreCounter++;
                    color = { background: '#6e7681', border: '#8b949e' };
                    shape = 'box';
                    deviceType = 'switch_core';
                    break;
                case 'computer':
                    name = 'PC' + computerCounter++;
                    color = { background: '#6e7681', border: '#8b949e' };
                    shape = 'circle';
                    deviceType = 'computer';
                    break;
            }
            
            const id = deviceType + '_' + Date.now();
            nodes.add({
                id: id,
                label: name,
                title: name,
                shape: shape,
                size: 30,
                x: x,
                y: y,
                color: color,
                font: {
                    color: '#ffffff',
                    size: 11
                },
                data: {
                    type: deviceType,
                    name: name,
                    connections: [],
                    vlan: null  // Para computadoras
                }
            });
            
            network.focus(id, {
                scale: 1.2,
                animation: {
                    duration: 500,
                    easingFunction: 'easeInOutQuad'
                }
            });
            
            showNotification(name + ' agregado');
        }

        // Agregar VLAN
        function addVLAN() {
            const name = document.getElementById('vlan-name').value.trim();
            const prefix = document.getElementById('vlan-prefix').value;
            
            if (!name) {
                showNotification('Ingresa un nombre para la VLAN', 'error');
                return;
            }
            
            // Verificar que no exista
            if (vlans.find(v => v.name === name)) {
                showNotification('Esta VLAN ya existe', 'error');
                return;
            }
            
            vlans.push({ name: name, prefix: prefix });
            document.getElementById('vlan-name').value = '';
            updateVLANList();
            showNotification('VLAN ' + name + ' agregada');
        }

        // Actualizar lista de VLANs
        function updateVLANList() {
            const list = document.getElementById('vlan-list');
            list.innerHTML = '';
            
            vlans.forEach((vlan, index) => {
                const item = document.createElement('div');
                item.className = 'vlan-item';
                item.innerHTML = `
                    <div class="vlan-item-info">
                        <div class="vlan-item-name">${vlan.name}</div>
                        <div class="vlan-item-prefix">Prefijo: /${vlan.prefix}</div>
                    </div>
                    <button class="vlan-item-delete" onclick="deleteVLAN(${index})">‚úï</button>
                `;
                list.appendChild(item);
            });
            
            // Actualizar select de computadoras
            updateComputerVlanSelect();
        }

        // Eliminar VLAN
        function deleteVLAN(index) {
            vlans.splice(index, 1);
            updateVLANList();
            showNotification('VLAN eliminada');
        }

        // Actualizar select de VLANs para computadoras
        function updateComputerVlanSelect() {
            const select = document.getElementById('computer-vlan-select');
            select.innerHTML = '<option value="">-- Selecciona VLAN --</option>';
            vlans.forEach(vlan => {
                const option = document.createElement('option');
                option.value = vlan.name;
                option.textContent = vlan.name + ' (/' + vlan.prefix + ')';
                select.appendChild(option);
            });
        }

        // Modo de conexi√≥n con toggle
        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            firstNodeConnection = null;
            
            const btn = document.getElementById('connect-btn');
            if (connectionMode) {
                btn.classList.add('active');
                showNotification('Modo conexi√≥n activado. Haz clic en dos dispositivos');
            } else {
                btn.classList.remove('active');
                showNotification('Modo conexi√≥n desactivado');
            }
        }
        
        // Mantener compatibilidad
        function enableConnectionMode() {
            if (!connectionMode) {
                toggleConnectionMode();
            }
        }

        // Manejar clic para conexi√≥n
        function handleConnectionClick(nodeId) {
            if (!firstNodeConnection) {
                firstNodeConnection = nodeId;
                const node = nodes.get(nodeId);
                showNotification('Seleccionado: ' + node.data.name + '. Ahora selecciona el destino');
            } else {
                if (firstNodeConnection === nodeId) {
                    showNotification('No puedes conectar un dispositivo consigo mismo', 'error');
                    firstNodeConnection = null;
                    return;
                }
                
                // Abrir modal para configurar conexi√≥n
                const fromNode = nodes.get(firstNodeConnection);
                const toNode = nodes.get(nodeId);
                
                // Resetear el modal a valores por defecto
                document.getElementById('new-connection-type').value = 'normal';
                document.getElementById('conn-from-type').value = 'fa';
                document.getElementById('conn-from-number').value = '0/0';
                document.getElementById('conn-to-type').value = 'fa';
                document.getElementById('conn-to-number').value = '0/0';
                
                // Resetear campos de EtherChannel
                document.getElementById('new-etherchannel-protocol').value = 'lacp';
                document.getElementById('new-etherchannel-group').value = '1';
                document.getElementById('new-etherchannel-from-type').value = 'fa';
                document.getElementById('new-etherchannel-from-range').value = '';
                document.getElementById('new-etherchannel-to-type').value = 'fa';
                document.getElementById('new-etherchannel-to-range').value = '';
                
                // Mostrar campos normales y ocultar EtherChannel
                document.getElementById('new-normal-fields').style.display = 'block';
                document.getElementById('new-etherchannel-fields').style.display = 'none';
                
                document.getElementById('conn-from-name').textContent = fromNode.data.name;
                document.getElementById('conn-to-name').textContent = toNode.data.name;
                document.getElementById('conn-to-name-ec').textContent = toNode.data.name;
                document.getElementById('connection-modal').style.display = 'block';
            }
        }

        // Guardar conexi√≥n
        /**
         * Guarda una nueva conexi√≥n entre dos dispositivos
         * Puede ser conexi√≥n normal o EtherChannel seg√∫n la selecci√≥n del usuario
         */
        function saveConnection() {
            const connectionType = document.getElementById('new-connection-type').value;
            
            // Encontrar el ID del nodo destino
            let toNodeId = null;
            const toNameElement = document.getElementById('conn-to-name');
            nodes.forEach(node => {
                if (node.data.name === toNameElement.textContent) {
                    toNodeId = node.id;
                }
            });
            
            const fromNode = nodes.get(firstNodeConnection);
            const toNode = nodes.get(toNodeId);
            
            // Determinar si debe tener direcciones de ruteo (solo router o switch_core)
            const isRoutingEdge = (fromNode.data.type === 'router' || fromNode.data.type === 'switch_core') &&
                                  (toNode.data.type === 'router' || toNode.data.type === 'switch_core');
            
            const initialDirection = isRoutingEdge ? 'bidirectional' : 'none';
            const edgeId = 'edge_' + Date.now();
            
            let edgeData = {
                id: edgeId,
                from: firstNodeConnection,
                to: toNodeId,
                arrows: getArrowsForDirection(initialDirection)
            };
            
            if (connectionType === 'etherchannel') {
                // Configuraci√≥n de EtherChannel
                const protocol = document.getElementById('new-etherchannel-protocol').value;
                const group = parseInt(document.getElementById('new-etherchannel-group').value);
                const fromType = document.getElementById('new-etherchannel-from-type').value;
                const fromRange = document.getElementById('new-etherchannel-from-range').value.trim();
                const toType = document.getElementById('new-etherchannel-to-type').value;
                const toRange = document.getElementById('new-etherchannel-to-range').value.trim();
                
                if (!fromRange || !toRange) {
                    showNotification('Completa los rangos de interfaces', 'error');
                    return;
                }
                
                // Validar formato de rango (ej: 0/1-3)
                const rangePattern = /^\d+\/\d+-\d+$/;
                if (!rangePattern.test(fromRange) || !rangePattern.test(toRange)) {
                    showNotification('Formato de rango inv√°lido. Usa formato: 0/1-3', 'error');
                    return;
                }
                
                // Datos de EtherChannel
                edgeData.data = {
                    etherChannel: {
                        protocol: protocol,
                        group: group,
                        fromType: fromType,
                        fromRange: fromRange,
                        toType: toType,
                        toRange: toRange
                    },
                    // Mantener interfaces para compatibilidad
                    fromInterface: { type: fromType, number: fromRange },
                    toInterface: { type: toType, number: toRange },
                    routingDirection: initialDirection,
                    connectionType: 'etherchannel'
                };
                
                // Estilo visual para EtherChannel
                edgeData.width = 6;
                edgeData.dashes = [2, 2];
                edgeData.smooth = { type: 'continuous' };
                edgeData.color = { color: '#58a6ff', highlight: '#79c0ff' };
                
            } else {
                // Conexi√≥n normal
                const fromType = document.getElementById('conn-from-type').value;
                const fromNumber = document.getElementById('conn-from-number').value.trim();
                const toType = document.getElementById('conn-to-type').value;
                const toNumber = document.getElementById('conn-to-number').value.trim();
                
                if (!fromNumber || !toNumber) {
                    showNotification('Completa todos los campos', 'error');
                    return;
                }
                
                edgeData.data = {
                    fromInterface: { type: fromType, number: fromNumber },
                    toInterface: { type: toType, number: toNumber },
                    routingDirection: initialDirection,
                    connectionType: 'normal'
                };
            }
            
            // Agregar la conexi√≥n al grafo
            edges.add(edgeData);
            
            closeConnectionModal();
            showNotification('Conexi√≥n creada');
            connectionMode = false;
            firstNodeConnection = null;
            document.getElementById('connect-btn').classList.remove('active');
        }

        // Cerrar modal de conexi√≥n
        function closeConnectionModal() {
            document.getElementById('connection-modal').style.display = 'none';
            
            // Resetear todos los campos a valores por defecto
            document.getElementById('new-connection-type').value = 'normal';
            document.getElementById('conn-from-type').value = 'fa';
            document.getElementById('conn-from-number').value = '0/0';
            document.getElementById('conn-to-type').value = 'fa';
            document.getElementById('conn-to-number').value = '0/0';
            
            // Resetear campos de EtherChannel
            document.getElementById('new-etherchannel-protocol').value = 'lacp';
            document.getElementById('new-etherchannel-group').value = '1';
            document.getElementById('new-etherchannel-from-type').value = 'fa';
            document.getElementById('new-etherchannel-from-range').value = '';
            document.getElementById('new-etherchannel-to-type').value = 'fa';
            document.getElementById('new-etherchannel-to-range').value = '';
            
            // Mostrar campos normales y ocultar EtherChannel
            document.getElementById('new-normal-fields').style.display = 'block';
            document.getElementById('new-etherchannel-fields').style.display = 'none';
            
            firstNodeConnection = null;
            connectionMode = false;
            document.getElementById('connect-btn').classList.remove('active');
        }

        // Seleccionar nodo
        function selectNode(nodeId) {
            selectedNode = nodeId;
            selectedEdge = null;
            const node = nodes.get(nodeId);
            
            if (node.data.type === 'computer') {
                showComputerProperties(node);
            } else {
                showDeviceProperties(node);
            }
        }

        // Seleccionar edge
        function selectEdge(edgeId) {
            selectedEdge = edgeId;
            selectedNode = null;
            showEdgeProperties(edgeId);
        }
        
        // Cambiar direcci√≥n de ruteo c√≠clicamente
        function cycleRoutingDirection(edgeId) {
            if (!edgeId) return;
            
            const edge = edges.get(edgeId);
            const currentDirection = edge.data.routingDirection || 'bidirectional';
            
            // Ciclo: bidirectional ‚Üí from-to ‚Üí to-from ‚Üí none ‚Üí bidirectional
            const cycle = {
                'bidirectional': 'from-to',
                'from-to': 'to-from',
                'to-from': 'none',
                'none': 'bidirectional'
            };
            
            const newDirection = cycle[currentDirection];
            
            // Actualizar edge
            edges.update({
                id: edgeId,
                data: {
                    ...edge.data,
                    routingDirection: newDirection
                },
                arrows: getArrowsForDirection(newDirection)
            });
            
            // Actualizar propiedades si este edge est√° seleccionado
            if (selectedEdge === edgeId) {
                showEdgeProperties(edgeId);
            }
            
            const directionNames = {
                'bidirectional': 'Bidireccional',
                'from-to': 'Unidireccional ‚Üí',
                'to-from': 'Unidireccional ‚Üê',
                'none': 'Sin ruteo'
            };
            showNotification('Direcci√≥n: ' + directionNames[newDirection]);
        }
        
        // Funciones de zoom
        function zoomIn() {
            const currentScale = network.getScale();
            if (currentScale < MAX_ZOOM) {
                network.moveTo({
                    scale: Math.min(currentScale * 1.2, MAX_ZOOM),
                    animation: { duration: 200, easingFunction: 'easeInOutQuad' }
                });
            }
        }
        
        function zoomOut() {
            const currentScale = network.getScale();
            if (currentScale > MIN_ZOOM) {
                network.moveTo({
                    scale: Math.max(currentScale / 1.2, MIN_ZOOM),
                    animation: { duration: 200, easingFunction: 'easeInOutQuad' }
                });
            }
        }

        // Mostrar propiedades de dispositivo
        function showDeviceProperties(node) {
            const typeNames = {
                'router': 'Router',
                'switch': 'Switch',
                'switch_core': 'Switch Core'
            };
            
            const content = document.getElementById('properties-content');
            
            // Bot√≥n de administrar computadoras solo para switches
            const computersButton = (node.data.type === 'switch' || node.data.type === 'switch_core') ? 
                '<button class="btn" onclick="openManageComputersModal()" style="background: #238636; margin-top: 10px;">üíª Administrar Computadoras</button>' : '';
            
            content.innerHTML = `
                <div class="property-group">
                    <h4>Nombre del Dispositivo</h4>
                    <div class="input-group">
                        <input type="text" id="device-name-input" value="${node.data.name}" style="margin-bottom: 10px;">
                    </div>
                    <button class="btn" onclick="updateDeviceName()">Cambiar Nombre</button>
                </div>
                <div class="property-group">
                    <h4>Tipo</h4>
                    <div style="color: #8b949e; font-size: 14px;">${typeNames[node.data.type] || node.data.type}</div>
                </div>
                ${computersButton}
                <div class="property-group">
                    <h4>Conexiones</h4>
                    <div id="device-connections"></div>
                </div>
            `;
            
            // Listar conexiones
            const conns = edges.get().filter(e => e.from === node.id || e.to === node.id);
            const connDiv = document.getElementById('device-connections');
            
            if (conns.length === 0) {
                connDiv.innerHTML = '<p style="color: #8b949e; font-size: 12px;">Sin conexiones</p>';
            } else {
                conns.forEach(edge => {
                    const otherNodeId = edge.from === node.id ? edge.to : edge.from;
                    const otherNode = nodes.get(otherNodeId);
                    const isFrom = edge.from === node.id;
                    const myInterface = isFrom ? edge.data.fromInterface : edge.data.toInterface;
                    
                    const item = document.createElement('div');
                    item.style.cssText = 'background: #21262d; padding: 10px; border-radius: 6px; margin-bottom: 8px;';
                    item.innerHTML = `
                        <div style="color: #c9d1d9; margin-bottom: 5px;">${otherNode.data.name}</div>
                        <div style="color: #8b949e; font-size: 11px;">
                            ${myInterface.type}${myInterface.number}
                        </div>
                    `;
                    connDiv.appendChild(item);
                });
            }
        }

        // Mostrar propiedades de computadora
        function showComputerProperties(node) {
            const content = document.getElementById('properties-content');
            const vlanInfo = node.data.vlan ? 
                `<div style="color: #238636; font-weight: bold;">${node.data.vlan}</div>` :
                `<div style="color: #8b949e;">Sin asignar</div>`;
            
            content.innerHTML = `
                <div class="property-group">
                    <h4>${node.data.name}</h4>
                    <div style="color: #8b949e; font-size: 12px;">Computadora</div>
                </div>
                <div class="property-group">
                    <h4>VLAN Asignada</h4>
                    ${vlanInfo}
                </div>
                <button class="btn" onclick="openComputerVlanModal()">Cambiar VLAN</button>
            `;
        }
        
        // Actualizar nombre de dispositivo
        function updateDeviceName() {
            if (!selectedNode) return;
            
            const newName = document.getElementById('device-name-input').value.trim();
            
            if (!newName) {
                showNotification('El nombre no puede estar vac√≠o', 'error');
                return;
            }
            
            // Verificar que el nombre no exista
            const existingNode = nodes.get().find(n => n.data.name === newName && n.id !== selectedNode);
            if (existingNode) {
                showNotification('Ya existe un dispositivo con ese nombre', 'error');
                return;
            }
            
            // Actualizar nodo
            nodes.update({
                id: selectedNode,
                label: newName,
                title: newName,
                data: {
                    ...nodes.get(selectedNode).data,
                    name: newName
                }
            });
            
            showNotification('Nombre actualizado');
            showDeviceProperties(nodes.get(selectedNode));
        }

        // Mostrar propiedades de conexi√≥n
        function showEdgeProperties(edgeId) {
            const edge = edges.get(edgeId);
            const fromNode = nodes.get(edge.from);
            const toNode = nodes.get(edge.to);
            
            const routingDirection = edge.data.routingDirection || 'bidirectional';
            const isEtherChannel = edge.data.etherChannel || edge.data.connectionType === 'etherchannel';
            
            // Determinar s√≠mbolo de direcci√≥n para la flecha central
            let directionSymbol = '‚Üï'; // bidireccional por defecto
            let directionLabel = 'Bidireccional';
            
            if (routingDirection === 'from-to') {
                directionSymbol = '‚Üí';
                directionLabel = 'Unidireccional';
            } else if (routingDirection === 'to-from') {
                directionSymbol = '‚Üê';
                directionLabel = 'Unidireccional';
            } else if (routingDirection === 'none') {
                directionSymbol = '‚Äî';
                directionLabel = 'Sin ruteo';
            }
            
            const content = document.getElementById('properties-content');
            
            let connectionInfo = '';
            
            if (isEtherChannel) {
                const ec = edge.data.etherChannel;
                const protocolName = ec.protocol === 'lacp' ? 'LACP' : 'PAgP';
                const modeFrom = ec.protocol === 'lacp' ? 'active' : 'desirable';
                const modeTo = ec.protocol === 'lacp' ? 'passive' : 'auto';
                
                connectionInfo = `
                    <div class="property-group">
                        <h4>EtherChannel</h4>
                        <div style="background: #21262d; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 10px;">
                                <div style="color: #58a6ff; font-weight: bold;">${fromNode.data.name}</div>
                                <div style="color: #8b949e; font-size: 11px;">
                                    ${ec.fromType}${ec.fromRange} ‚Üí Port-channel ${ec.group}
                                </div>
                                <div style="color: #6e7681; font-size: 10px; margin-top: 3px;">
                                    Modo: ${modeFrom}
                                </div>
                            </div>
                            <div style="text-align: center; color: #8b949e; margin: 10px 0; font-size: 18px;">‚ö° ${protocolName} ‚ö°</div>
                            <div>
                                <div style="color: #58a6ff; font-weight: bold;">${toNode.data.name}</div>
                                <div style="color: #8b949e; font-size: 11px;">
                                    ${ec.toType}${ec.toRange} ‚Üí Port-channel ${ec.group}
                                </div>
                                <div style="color: #6e7681; font-size: 10px; margin-top: 3px;">
                                    Modo: ${modeTo}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                connectionInfo = `
                    <div class="property-group">
                        <h4>Conexi√≥n</h4>
                        <div style="background: #21262d; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 10px;">
                                <div style="color: #58a6ff; font-weight: bold;">${fromNode.data.name}</div>
                                <div style="color: #8b949e; font-size: 11px;">
                                    ${edge.data.fromInterface.type}${edge.data.fromInterface.number}
                                </div>
                            </div>
                            <div style="text-align: center; color: #8b949e; margin: 10px 0; font-size: 18px;">${directionSymbol}</div>
                            <div>
                                <div style="color: #58a6ff; font-weight: bold;">${toNode.data.name}</div>
                                <div style="color: #8b949e; font-size: 11px;">
                                    ${edge.data.toInterface.type}${edge.data.toInterface.number}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                ${connectionInfo}
                ${!isEtherChannel ? `
                <div class="property-group">
                    <h4>Direcci√≥n de Ruteo</h4>
                    <div style="background: #21262d; padding: 12px; border-radius: 6px; color: #8b949e;">
                        ${directionLabel}
                    </div>
                </div>` : ''}
                <button class="btn" onclick="openEditConnectionModal()">Editar Conexi√≥n</button>
                <button class="btn btn-danger" onclick="deleteConnection()" style="margin-top: 10px;">Eliminar Conexi√≥n</button>
            `;
        }

        // Abrir modal para editar conexi√≥n
        function openEditConnectionModal() {
            if (!selectedEdge) return;
            
            const edge = edges.get(selectedEdge);
            editingEdge = selectedEdge;
            
            const isEtherChannel = edge.data.etherChannel || edge.data.connectionType === 'etherchannel';
            
            document.getElementById('edit-connection-type').value = isEtherChannel ? 'etherchannel' : 'normal';
            
            if (isEtherChannel) {
                // Cargar datos de EtherChannel
                document.getElementById('etherchannel-protocol').value = edge.data.etherChannel.protocol || 'lacp';
                document.getElementById('etherchannel-group').value = edge.data.etherChannel.group || 1;
                document.getElementById('etherchannel-from-type').value = edge.data.etherChannel.fromType || 'fa';
                document.getElementById('etherchannel-from-range').value = edge.data.etherChannel.fromRange || '';
                document.getElementById('etherchannel-to-type').value = edge.data.etherChannel.toType || 'fa';
                document.getElementById('etherchannel-to-range').value = edge.data.etherChannel.toRange || '';
            } else {
                // Cargar datos de conexi√≥n normal
                document.getElementById('edit-from-type').value = edge.data.fromInterface.type;
                document.getElementById('edit-from-number').value = edge.data.fromInterface.number;
                document.getElementById('edit-to-type').value = edge.data.toInterface.type;
                document.getElementById('edit-to-number').value = edge.data.toInterface.number;
            }
            
            toggleEtherChannelFields();
            document.getElementById('edit-connection-modal').style.display = 'block';
        }

        /**
         * Alterna entre campos de conexi√≥n normal y EtherChannel en modal de edici√≥n
         * Valida que ambos extremos sean switches antes de permitir EtherChannel
         */
        function toggleEtherChannelFields() {
            const connectionType = document.getElementById('edit-connection-type').value;
            const normalFields = document.getElementById('normal-connection-fields');
            const etherChannelFields = document.getElementById('etherchannel-fields');
            
            if (connectionType === 'etherchannel') {
                // Validar que ambos extremos sean switches
                const edge = edges.get(editingEdge);
                const fromNode = nodes.get(edge.from);
                const toNode = nodes.get(edge.to);
                
                const fromIsSwitch = fromNode.data.type === 'switch' || fromNode.data.type === 'switch_core';
                const toIsSwitch = toNode.data.type === 'switch' || toNode.data.type === 'switch_core';
                
                if (!fromIsSwitch || !toIsSwitch) {
                    showNotification('EtherChannel solo puede configurarse entre switches', 'error');
                    document.getElementById('edit-connection-type').value = 'normal';
                    normalFields.style.display = 'block';
                    etherChannelFields.style.display = 'none';
                    return;
                }
                
                normalFields.style.display = 'none';
                etherChannelFields.style.display = 'block';
            } else {
                normalFields.style.display = 'block';
                etherChannelFields.style.display = 'none';
            }
        }

        /**
         * Alterna entre campos normales y EtherChannel en modal de NUEVA conexi√≥n
         * Valida que ambos nodos seleccionados sean switches
         */
        function toggleNewConnectionFields() {
            const connectionType = document.getElementById('new-connection-type').value;
            const normalFields = document.getElementById('new-normal-fields');
            const etherChannelFields = document.getElementById('new-etherchannel-fields');
            
            if (connectionType === 'etherchannel') {
                // Validar que ambos nodos sean switches
                if (firstNodeConnection) {
                    const fromNode = nodes.get(firstNodeConnection);
                    const fromIsSwitch = fromNode.data.type === 'switch' || fromNode.data.type === 'switch_core';
                    
                    if (!fromIsSwitch) {
                        showNotification('EtherChannel solo funciona entre switches', 'error');
                        document.getElementById('new-connection-type').value = 'normal';
                        return;
                    }
                }
                
                normalFields.style.display = 'none';
                etherChannelFields.style.display = 'block';
                // Copiar nombre del destino tambi√©n en secci√≥n EtherChannel
                document.getElementById('conn-to-name-ec').textContent = 
                    document.getElementById('conn-to-name').textContent;
            } else {
                normalFields.style.display = 'block';
                etherChannelFields.style.display = 'none';
            }
        }

        // Guardar conexi√≥n editada
        function saveEditedConnection() {
            const connectionType = document.getElementById('edit-connection-type').value;
            const edge = edges.get(editingEdge);
            const currentDirection = edge.data.routingDirection || 'bidirectional';
            
            let updatedData = {
                id: editingEdge,
                arrows: getArrowsForDirection(currentDirection)
            };
            
            if (connectionType === 'etherchannel') {
                // Validar campos de EtherChannel
                const protocol = document.getElementById('etherchannel-protocol').value;
                const group = parseInt(document.getElementById('etherchannel-group').value);
                const fromType = document.getElementById('etherchannel-from-type').value;
                const fromRange = document.getElementById('etherchannel-from-range').value.trim();
                const toType = document.getElementById('etherchannel-to-type').value;
                const toRange = document.getElementById('etherchannel-to-range').value.trim();
                
                if (!fromRange || !toRange) {
                    showNotification('Completa los rangos de interfaces', 'error');
                    return;
                }
                
                // Validar formato de rango (ej: 0/1-3)
                const rangePattern = /^\d+\/\d+-\d+$/;
                if (!rangePattern.test(fromRange) || !rangePattern.test(toRange)) {
                    showNotification('Formato de rango inv√°lido. Usa formato: 0/1-3', 'error');
                    return;
                }
                
                updatedData.data = {
                    etherChannel: {
                        protocol: protocol,
                        group: group,
                        fromType: fromType,
                        fromRange: fromRange,
                        toType: toType,
                        toRange: toRange
                    },
                    // IMPORTANTE: Mantener las interfaces tambi√©n para compatibilidad
                    fromInterface: { type: fromType, number: fromRange },
                    toInterface: { type: toType, number: toRange },
                    routingDirection: currentDirection,
                    connectionType: 'etherchannel'
                };
                
                // Estilo visual para EtherChannel (3 l√≠neas gruesas)
                updatedData.width = 6;
                updatedData.dashes = [2, 2];
                updatedData.smooth = { type: 'continuous' };
                updatedData.color = { color: '#58a6ff', highlight: '#79c0ff' };
                
            } else {
                // Conexi√≥n normal
                const fromType = document.getElementById('edit-from-type').value;
                const fromNumber = document.getElementById('edit-from-number').value.trim();
                const toType = document.getElementById('edit-to-type').value;
                const toNumber = document.getElementById('edit-to-number').value.trim();
                
                if (!fromNumber || !toNumber) {
                    showNotification('Completa todos los campos', 'error');
                    return;
                }
                
                updatedData.data = {
                    fromInterface: { type: fromType, number: fromNumber },
                    toInterface: { type: toType, number: toNumber },
                    routingDirection: currentDirection,
                    connectionType: 'normal'
                };
                
                // Restaurar estilo normal
                updatedData.width = 2;
                updatedData.dashes = false;
                updatedData.color = { color: '#8b949e', highlight: '#58a6ff' };
            }
            
            edges.update(updatedData);
            closeEditConnectionModal();
            showNotification('Conexi√≥n actualizada');
            selectEdge(editingEdge);
        }

        // Cerrar modal de edici√≥n
        function closeEditConnectionModal() {
            document.getElementById('edit-connection-modal').style.display = 'none';
            editingEdge = null;
        }

        // Eliminar conexi√≥n
        function deleteConnection() {
            if (!selectedEdge) return;
            edges.remove(selectedEdge);
            showNotification('Conexi√≥n eliminada');
            clearSelection();
        }

        // Abrir modal de VLAN para computadora
        function openComputerVlanModal() {
            if (!selectedNode) return;
            
            const node = nodes.get(selectedNode);
            if (node.data.type !== 'computer') return;
            
            document.getElementById('computer-name').textContent = node.data.name;
            document.getElementById('computer-vlan-select').value = node.data.vlan || '';
            document.getElementById('computer-vlan-modal').style.display = 'block';
        }

        // Guardar VLAN de computadora
        function saveComputerVlan() {
            const vlanName = document.getElementById('computer-vlan-select').value;
            
            if (!vlanName) {
                showNotification('Selecciona una VLAN', 'error');
                return;
            }
            
            const node = nodes.get(selectedNode);
            const currentPosition = network.getPositions([selectedNode])[selectedNode];
            
            node.data.vlan = vlanName;
            // Mantener posici√≥n al actualizar
            node.x = currentPosition.x;
            node.y = currentPosition.y;
            nodes.update(node);
            
            closeComputerVlanModal();
            showNotification('VLAN asignada a ' + node.data.name);
            selectNode(selectedNode);
        }

        // Cerrar modal de VLAN
        function closeComputerVlanModal() {
            document.getElementById('computer-vlan-modal').style.display = 'none';
        }

        // Administrar computadoras del switch
        let currentSwitchForComputers = null; // Variable para guardar el switch actual
        
        function openManageComputersModal() {
            console.log('openManageComputersModal - selectedNode:', selectedNode);
            
            if (!selectedNode) {
                showNotification('Selecciona un switch primero', 'error');
                return;
            }
            
            // Obtener el nodo completo desde la colecci√≥n
            let node;
            if (typeof selectedNode === 'string') {
                // Si selectedNode es un ID string, obtener el nodo completo
                node = nodes.get(selectedNode);
            } else if (selectedNode.id) {
                // Si selectedNode tiene id, obtener el nodo completo
                node = nodes.get(selectedNode.id);
            } else {
                // Si selectedNode ya es el objeto completo
                node = selectedNode;
            }
            
            console.log('node obtenido:', node);
            console.log('node.data:', node ? node.data : 'undefined');
            
            if (!node || !node.data) {
                showNotification('Error al obtener informaci√≥n del switch', 'error');
                return;
            }
            
            console.log('node.data.type:', node.data.type);
            
            if (node.data.type !== 'switch' && node.data.type !== 'switch_core') {
                showNotification('Solo puedes administrar computadoras en switches', 'error');
                return;
            }
            
            // Guardar referencia al switch
            currentSwitchForComputers = node;
            
            const switchName = currentSwitchForComputers.data.name;
            document.getElementById('switch-computers-name').textContent = switchName;
            
            // Inicializar si no existe
            if (!currentSwitchForComputers.data.computers) {
                currentSwitchForComputers.data.computers = [];
            }
            
            updateComputersList();
            document.getElementById('manage-computers-modal').style.display = 'block';
        }
        
        function closeManageComputersModal() {
            document.getElementById('manage-computers-modal').style.display = 'none';
        }
        
        function updateComputersList() {
            const listDiv = document.getElementById('computers-list');
            const computers = currentSwitchForComputers.data.computers || [];
            
            if (computers.length === 0) {
                listDiv.innerHTML = '<p style="color: #8b949e; font-size: 12px; text-align: center; padding: 20px;">No hay computadoras conectadas</p>';
                return;
            }
            
            listDiv.innerHTML = '';
            computers.forEach((pc, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #21262d; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';
                item.innerHTML = `
                    <div>
                        <div style="color: #58a6ff; font-weight: bold; margin-bottom: 4px;">${pc.name}</div>
                        <div style="color: #8b949e; font-size: 11px;">Puerto: ${pc.portType}${pc.portNumber} ‚Ä¢ VLAN: ${pc.vlan}</div>
                    </div>
                    <button onclick="removeComputer(${index})" style="background: #da3633; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>
                `;
                listDiv.appendChild(item);
            });
        }
        
        function removeComputer(index) {
            if (confirm('¬øEliminar esta computadora?')) {
                currentSwitchForComputers.data.computers.splice(index, 1);
                nodes.update(currentSwitchForComputers);
                updateComputersList();
                showNotification('Computadora eliminada');
            }
        }
        
        function openAddComputerModal() {
            console.log('openAddComputerModal llamada');
            console.log('currentSwitchForComputers:', currentSwitchForComputers);
            
            // Generar nombre autom√°tico
            const existingComputers = currentSwitchForComputers.data.computers || [];
            const pcCount = existingComputers.length + 1;
            document.getElementById('new-pc-name').value = `PC${pcCount}`;
            
            console.log('Nombre generado:', `PC${pcCount}`);
            
            // Llenar select de VLANs - USAR ARRAY VLANS DIRECTAMENTE
            const vlanSelect = document.getElementById('new-pc-vlan');
            vlanSelect.innerHTML = '<option value="">-- Selecciona VLAN --</option>';
            
            if (vlans.length === 0) {
                showNotification('No hay VLANs creadas. Crea VLANs primero.', 'error');
                return;
            }
            
            console.log('VLANs encontradas:', vlans.length);
            
            // Usar directamente el array vlans, no parsear el HTML
            for (let i = 0; i < vlans.length; i++) {
                const vlanName = vlans[i].name; // Solo el nombre, sin el prefijo
                const option = document.createElement('option');
                option.value = vlanName;
                option.textContent = vlanName;
                vlanSelect.appendChild(option);
            }
            
            // Limpiar otros campos
            document.getElementById('new-pc-port-number').value = '';
            
            console.log('Abriendo modal...');
            document.getElementById('add-computer-modal').style.display = 'block';
        }
        
        function closeAddComputerModal() {
            document.getElementById('add-computer-modal').style.display = 'none';
        }
        
        function saveNewComputer() {
            const name = document.getElementById('new-pc-name').value.trim();
            const portType = document.getElementById('new-pc-port-type').value;
            const portNumber = document.getElementById('new-pc-port-number').value.trim();
            const vlan = document.getElementById('new-pc-vlan').value;
            
            console.log('Datos de nueva PC:', { name, portType, portNumber, vlan });
            
            if (!name) {
                showNotification('Ingresa el nombre de la PC', 'error');
                return;
            }
            
            if (!portNumber) {
                showNotification('Ingresa el puerto del switch', 'error');
                return;
            }
            
            if (!vlan) {
                showNotification('Selecciona una VLAN', 'error');
                return;
            }
            
            // Validar formato de puerto
            const portPattern = /^\d+\/\d+$/;
            if (!portPattern.test(portNumber)) {
                showNotification('Formato de puerto inv√°lido. Usa formato: 0/1', 'error');
                return;
            }
            
            // Verificar que el puerto no est√© en uso
            const computers = currentSwitchForComputers.data.computers || [];
            const portInUse = computers.some(pc => pc.portType === portType && pc.portNumber === portNumber);
            if (portInUse) {
                showNotification('Ese puerto ya est√° en uso', 'error');
                return;
            }
            
            // Agregar computadora
            if (!currentSwitchForComputers.data.computers) {
                currentSwitchForComputers.data.computers = [];
            }
            
            currentSwitchForComputers.data.computers.push({
                name: name,
                portType: portType,
                portNumber: portNumber,
                vlan: vlan
            });
            
            console.log('Computadora agregada:', currentSwitchForComputers.data.computers);
            
            nodes.update(currentSwitchForComputers);
            updateComputersList();
            closeAddComputerModal();
            showNotification(`Computadora ${name} agregada`);
        }

        // Limpiar selecci√≥n
        function clearSelection() {
            selectedNode = null;
            selectedEdge = null;
            const content = document.getElementById('properties-content');
            content.innerHTML = `
                <p style="color: #8b949e; text-align: center; padding: 40px 20px;">
                    Selecciona un elemento para ver sus propiedades
                </p>
            `;
        }

        // Eliminar selecci√≥n
        function deleteSelected() {
            if (selectedNode) {
                const node = nodes.get(selectedNode);
                // Eliminar todas las conexiones del nodo
                const connectedEdges = edges.get().filter(e => e.from === selectedNode || e.to === selectedNode);
                connectedEdges.forEach(e => edges.remove(e.id));
                
                nodes.remove(selectedNode);
                showNotification(node.data.name + ' eliminado');
                clearSelection();
            } else if (selectedEdge) {
                deleteConnection();
            } else {
                showNotification('Selecciona un elemento primero', 'error');
            }
        }

        // Generar configuraciones
        function generateConfigurations() {
            if (nodes.length === 0) {
                showNotification('Agrega dispositivos primero', 'error');
                return;
            }
            
            // Crear formulario y enviar datos a nueva pesta√±a
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/';
            form.target = '_blank';  // Abrir en nueva pesta√±a
            
            // Serializar datos
            const data = {
                nodes: nodes.get(),
                edges: edges.get(),
                vlans: vlans
            };
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'topology_data';
            input.value = JSON.stringify(data);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            
            // Mostrar notificaci√≥n
            showNotification('Generando configuraciones en nueva pesta√±a...');
            
            // Remover formulario despu√©s de enviar
            setTimeout(() => {
                document.body.removeChild(form);
            }, 100);
        }

        // Notificaci√≥n
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + (type === 'error' ? 'error' : '');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Inicializar al cargar
        window.onload = function() {
            initNetwork();
        };

        // Cerrar modales al hacer clic fuera del contenido
        window.onclick = function(event) {
            const modals = ['connection-modal', 'edit-connection-modal', 'computer-vlan-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    // Limpiar estado si es modal de conexi√≥n
                    if (modalId === 'connection-modal') {
                        firstNodeConnection = null;
                        connectionMode = false;
                        document.getElementById('connect-btn').classList.remove('active');
                    }
                }
            });
        };
    </script>
</body>
</html>
